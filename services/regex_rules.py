# services/regex_rules.py
from __future__ import annotations
import re

# ===== 기본 플래그 =====
X = re.VERBOSE
I = re.IGNORECASE
M = re.MULTILINE
S = re.DOTALL

PATTERNS = {
    # PHONE (전화번호)
    "PHONE": re.compile(r"""
(?x)
(?<!\d)
(
  \+82[ -]?(?:10|11|16|17|18|19|2|[3-6][1-5]|[7-9]\d)[ -]?\d{3,4}[ -]?\d{4}
  |
  0(?:10|11|16|17|18|19)[ -]?\d{3,4}[ -]?\d{4}
  |
  0(?:2|[3-6][1-5]|[7-9]\d)[ -]?\d{3,4}[ -]?\d{4}
  |
  0(?:70|80)[ -]?\d{3,4}[ -]?\d{4}
  |
  1(?:5|6|8)\d{2}[ -]?\d{4}
  |
  \+?[1-9]\d{7,14}
  |
  \+?[1-9]\d{0,2}[ -]?\d{1,4}(?:[ -]?\d{2,4}){2,4}
)
(?:\s*(?:ext\.?|x)\s*\d{1,5})?
(?!\d)
""", X),

    # EMAIL
    "EMAIL": re.compile(r"""
(?xi)
(?<=^|[\s<\(\["':.,;!?=]|[가-힣])
(?:
  (?:"[^"\r\n]*"\s*)?<
    (?P<email>[A-Za-z0-9._%+-]{1,64}@
      (?:[A-Za-z0-9](?:[A-Za-z0-9-]{0,61}[A-Za-z0-9])?\.)+
      [A-Za-z]{2,63}
    )
  >
  |
  (?=.{1,254}$)
  (?!\.)
  (?!.*\.\.)
  (?P<email>[A-Za-z0-9._%+-]{1,64}@
    (?:[A-Za-z0-9](?:[A-Za-z0-9-]{0,61}[A-Za-z0-9])?\.)+
    [A-Za-z]{2,63}
  )
)
(?=$|[\s>\)\]"':.,;!?=]|[가-힣])
""", X | I),

    # PERSONAL_CUSTOMS_ID (개인통관고유부호)
    "PERSONAL_CUSTOMS_ID": re.compile(r"(?i)\bP-?\d{12}\b"),

    # RESIDENT_ID (주민등록번호)
    "RESIDENT_ID": re.compile(r"""
(?x)
(?<!\d)
(?: (?:0[1-9]|[1-9]\d)
    (?:
      (?:0[13578]|1[02])(?:0[1-9]|[12]\d|3[01]) |
      (?:0[469]|11)(?:0[1-9]|[12]\d|30)        |
      02(?:0[1-9]|1\d|2\d)
    )
)
-[1-4]\d{6}
(?!\d)
""", X),

    # PASSPORT
    "PASSPORT": re.compile(r"\b(?:[A-Z]\d{8}|[A-Z]{2}\d{7})\b"),

    # DRIVER_LICENSE
    "DRIVER_LICENSE": re.compile(r"(?<!\d)\d{2}-\d{2}-\d{6}-\d{2}(?!\d)"),

    # FOREIGNER_ID (외국인등록번호)
    "FOREIGNER_ID": re.compile(r"""
(?x)
(?<!\d)
(?: (?:0[1-9]|[1-9]\d)
    (?:
      (?:0[13578]|1[02])(?:0[1-9]|[12]\d|3[01]) |
      (?:0[469]|11)(?:0[1-9]|[12]\d|30)        |
      02(?:0[1-9]|1\d|2\d)
    )
)
-[5-8]\d{6}
(?!\d)
""", X),

    # BUSINESS_ID (사업자등록번호)
    "BUSINESS_ID": re.compile(r"(?<!\d)\d{3}-\d{2}-\d{5}(?!\d)"),

    # MILITARY_ID (군번)
    "MILITARY_ID": re.compile(r"(?<![A-Za-z0-9])\d{2}-(?:\d{6}|\d{7}|\d{8})(?![A-Za-z0-9])"),

    # API_KEY (구글/오픈AI/카카오)
    "API_KEY": re.compile(r"""
(?x)
(?<![A-Za-z0-9])
(?:
  AIza[0-9A-Za-z_-]{35}
  |
  (?:sk-[A-Za-z0-9]{32,64} | sk-(?:live|test)-[A-Za-z0-9]{24,64} | sk-proj-[A-Za-z0-9]{24,64})
  |
  (?i:KakaoAK)\s+(?P<kakao>[0-9a-f]{32})
)
(?![A-Za-z0-9])
""", X),

    # GITHUB_PAT
    "GITHUB_PAT": re.compile(r"""
(?xi)
(?<![0-9A-Za-z])
(?:
  (?:ghp|gho|ghu|ghs|ghr)_[A-Za-z0-9_]{36}
  |
  github_pat_[A-Za-z0-9_]{22,255}
)
(?![0-9A-Za-z])
""", X | I),

    # PRIVATE_KEY (SSH/TLS/PGP 개인키 - 멀티라인)
    "PRIVATE_KEY": re.compile(r"""
(?ms)
^-----BEGIN OPENSSH PRIVATE KEY-----\r?\n[A-Za-z0-9+/=\r\n]+^-----END OPENSSH PRIVATE KEY-----$
|
^-----BEGIN (?:RSA|EC|DSA) PRIVATE KEY-----\r?\n(?:[A-Za-z0-9+/=\r\n]+)^-----END (?:RSA|EC|DSA) PRIVATE KEY-----$
|
^-----BEGIN (?:ENCRYPTED )?PRIVATE KEY-----\r?\n[A-Za-z0-9+/=\r\n]+^-----END (?:ENCRYPTED )?PRIVATE KEY-----$
|
^-----BEGIN PGP PRIVATE KEY BLOCK-----\r?\n[\s\S]+?^-----END PGP PRIVATE KEY BLOCK-----$
""", M | S),

    # CARD_NUMBER (루한은 후처리)
    "CARD_NUMBER": re.compile(r"(?x)(?<!\d)(?:\d[ -]?){13,19}(?!\d)"),

    # IMEI (루한은 후처리)
    "IMEI": re.compile(r"(?x)(?<!\d)(?:\d[ -]?){15}(?!\d)"),

    # CARD_EXPIRY (선택)
    "CARD_EXPIRY": re.compile(r"(?x)(?<!\d)(0[1-9]|1[0-2])\s*[\/\-]\s*(?:\d{2}|\d{4})(?!\d)"),

    # BANK_ACCOUNT (국내 예시들 – 포맷 다양, 과탐 가능)
    "BANK_ACCOUNT": re.compile(r"""
(?x)
(?<!\d)
(?:
  \d{3}[- ]\d{2}[- ]\d{5}[- ]\d{1} |
  \d{3}[- ]\d{7}[- ]\d{1}[- ]\d{3} |
  \d{3}[- ]\d{8}[- ]\d{3}          |
  \d{3}[- ]\d{2}[- ]\d{6}[- ]\d{1} |
  \d{3}[- ]\d{6}[- ]\d{2}[- ]\d{2}(?:[- ]\d)? |
  \d{6}[- ]\d{2}[- ]\d{5}[- ]\d{1} |
  \d{4}[- ]\d{2}[- ]\d{7}[- ]\d{1} |
  \d{3}[- ]\d{2}[- ]\d{4}[- ]\d{2}[- ]\d{1} |
  \d{6}[- ]\d{2}[- ]\d{6}[- ]\d{1} |
  \d{3}[- ]\d{6}[- ]\d{2}[- ]\d{1}[- ]\d{2} |
  \d{3}[- ]\d{2}[- ]\d{5}[- ]\d{1} |
  \d{3}[- ]\d{6}[- ]\d{2}[- ]\d{1} |
  \d{4}[- ]\d{4}[- ]\d{3}[- ]\d{1} |
  \d{3}[- ]\d{2}[- ]\d{8}[- ]\d{1} |
  \d{3,4}[- ]\d{2}[- ]\d{5}[- ]\d{1} |
  \d{3}[- ]\d{4}[- ]\d{4}[- ]\d{1}[- ]\d{1} |
  \d{6}[- ]\d{2}[- ]\d{5}[- ]\d{1} |
  \d{1}[- ]\d{3}[- ]\d{1}[- ]\d{2}[- ]\d{6} |
  \d{3}[- ]\d{2}[- ]\d{5}[- ]\d{1} |
  \d{3}[- ]\d{2}[- ]\d{8}[- ]\d{1} |
  \d{3}[- ]\d{3}[- ]\d{5}[- ]\d{1} |
  \d{3}[- ]\d{3}[- ]\d{7}[- ]\d{1} |
  \d{3}[- ]\d{2}[- ]\d{5}[- ]\d{1} |
  \d{3}[- ]\d{2}[- ]\d{7}[- ]\d{1} |
  \d{3}[- ]\d{3}[- ]\d{7}[- ]\d{1} |
  \d{3}[- ]\d{2}[- ]\d{6}[- ]\d{1} |
  \d{3}[- ]\d{2}[- ]\d{5,6}[- ]\d{1} |
  \d{3}[- ]\d{2}[- ]\d{6}[- ]\d{3} |
  \d{1}[- ]\d{3}[- ]\d{4}[- ]\d{4}[- ]\d{1} |
  \d{4}[- ]\d{2,3}[- ]\d{6}[- ]\d{1} |
  \d{3}[- ]\d{3}[- ]\d{6} |
  \d{1}[- ]\d{9} |
  \d{1}[- ]\d{4}[- ]\d{3}[- ]\d{4} |
  \d{1}[- ]\d{3}[- ]\d{2}[- ]\d{7} |
  \d{4}[- ]\d{4}[- ]\d{3}[- ]\d{1}
)
(?!\d)
""", X),

    # HD_WALLET (xpub/xprv…)
    "HD_WALLET": re.compile(r"\b(?:xpub|ypub|zpub|tpub|xprv|yprv|zprv|tprv)[1-9A-HJ-NP-Za-km-z]{80,108}\b"),

    # PAYMENT_URI_QR: Bitcoin/Ethereum 예시
    "PAYMENT_URI_QR": re.compile(r"""
(?x)
\b(?: # BTC BIP-21 (legacy/segwit/bech32)
   bitcoin:(?:[13mn][1-9A-HJ-NP-Za-km-z]{25,34}|bc1[ac-hj-np-z02-9]{11,71})(?:\?[A-Za-z0-9%&=_+.\-]+)?
  |
   ethereum:0x[a-fA-F0-9]{40}(?:\?[A-Za-z0-9%&=_+.\-]+)?
)\b
""", X | I),

    # IPV4 (CIDR/포트)
    "IPV4": re.compile(r"""
(?x)
(?<!\d)
(?:
  (?:25[0-5]|2[0-4]\d|1?\d?\d)\.
  (?:25[0-5]|2[0-4]\d|1?\d?\d)\.
  (?:25[0-5]|2[0-4]\d|1?\d?\d)\.
  (?:25[0-5]|2[0-4]\d|1?\d?\d)
)
(?:/(?:3[0-2]|[12]?\d))?
(?::(?:6553[0-5]|655[0-2]\d|65[0-4]\d{2}|6[0-4]\d{3}|[1-5]?\d{1,4}))?
(?!\d)
""", X),

    # IPV6 (브래킷/비브래킷)
    "IPV6": re.compile(r"""
(?xms)
(
  \[ # bracketed
    (?:
      (?:[A-Fa-f0-9]{1,4}:){7}[A-Fa-f0-9]{1,4}|
      (?:[A-Fa-f0-9]{1,4}:){1,7}:|
      :(?:[A-Fa-f0-9]{1,4}:){1,7}[A-Fa-f0-9]{1,4}|
      (?:[A-Fa-f0-9]{1,4}:){1,6}:[A-Fa-f0-9]{1,4}|
      (?:[A-Fa-f0-9]{1,4}:){1,5}(?::[A-Fa-f0-9]{1,4}){1,2}|
      (?:[A-Fa-f0-9]{1,4}:){1,4}(?::[A-Fa-f0-9]{1,4}){1,3}|
      (?:[A-Fa-f0-9]{1,4}:){1,3}(?::[A-Fa-f0-9]{1,4}){1,4}|
      (?:[A-Fa-f0-9]{1,4}:){1,2}(?::[A-Fa-f0-9]{1,4}){1,5}|
      [A-Fa-f0-9]{1,4}:(?:(?::[A-Fa-f0-9]{1,4}){1,6})|
      :(?:(?::[A-Fa-f0-9]{1,4}){1,7}|:)|
      (?:[A-Fa-f0-9]{1,4}:){1,4}(?:(?:25[0-5]|2[0-4]\d|1?\d?\d)\.){3}(?:25[0-5]|2[0-4]\d|1?\d?\d)
    )
    (?:%[0-9A-Za-z.\-_:]+)?
  \]
  (?:/(?:12[0-8]|1[01]\d|\d{1,2}))?(?::(?:6553[0-5]|655[0-2]\d|65[0-4]\d{2}|6[0-4]\d{3}|[1-5]?\d{1,4}))?
)
|
(
  (?<![:\w])
  (?:
    (?:[A-Fa-f0-9]{1,4}:){7}[A-Fa-f0-9]{1,4}|
    (?:[A-Fa-f0-9]{1,4}:){1,7}:|
    :(?:[A-Fa-f0-9]{1,4}:){1,7}[A-Fa-f0-9]{1,4}|
    (?:[A-Fa-f0-9]{1,4}:){1,6}:[A-Fa-f0-9]{1,4}|
    (?:[A-Fa-f0-9]{1,4}:){1,5}(?::[A-Fa-f0-9]{1,4}){1,2}|
    (?:[A-Fa-f0-9]{1,4}:){1,4}(?::[A-Fa-f0-9]{1,4}){1,3}|
    (?:[A-Fa-f0-9]{1,4}:){1,3}(?::[A-Fa-f0-9]{1,4}){1,4}|
    (?:[A-Fa-f0-9]{1,4}:){1,2}(?::[A-Fa-f0-9]{1,4}){1,5}|
    [A-Fa-f0-9]{1,4}:(?:(?::[A-Fa-f0-9]{1,4}){1,6})|
    :(?:(?::[A-Fa-f0-9]{1,4}){1,7}|:)|
    (?:[A-Fa-f0-9]{1,4}:){1,4}
      (?:(?:25[0-5]|2[0-4]\d|1?\d?\d)\.){3}
      (?:25[0-5]|2[0-4]\d|1?\d?\d)
  )
  (?:%[0-9A-Za-z.\-_:]+)? (?:/(?:12[0-8]|1[01]\d|\d{1,2}))?
  (?![:\w])
)
""", X | M | S),

    # MAC_ADDRESS
    "MAC_ADDRESS": re.compile(r"(?xi)(?=[0-9A-F]{2}([-:]))[0-9A-F]{2}(?:\1[0-9A-F]{2}){5}(?=.*[A-F])"),
}
