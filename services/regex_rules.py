# services/regex_rules.py
from __future__ import annotations
import re
from typing import Callable, Iterator, Match

# ===== ê¸°ë³¸ í”Œë˜ê·¸ =====
X = re.VERBOSE
I = re.IGNORECASE
M = re.MULTILINE
S = re.DOTALL

# ---------------------------
# ì •ê·œì‹ íŒ¨í„´
# ---------------------------
PATTERNS = {

# PHONE (ì „í™”ë²ˆí˜¸)
"PHONE": re.compile(r"""
(?x)
(?<!\d)
(
  \+82[ -]?(?:10|11|16|17|18|19|2|[3-6][1-5]|[7-9]\d)[ -]?\d{3,4}[ -]?\d{4}
  |
  0(?:10|11|16|17|18|19)[ -]?\d{3,4}[ -]?\d{4}
  |
  0(?:2|[3-6][1-5]|[7-9]\d)[ -]?\d{3,4}[ -]?\d{4}
  |
  0(?:70|80)[ -]?\d{3,4}[ -]?\d{4}
  |
  1(?:5|6|8)\d{2}[ -]?\d{4}
  |
  \+
  (?=(?:\D*\d){8,15})
  [1-9]\d{0,2}(?:[ -]?\d{2,4}){2,5}
)
(?!\d)
""", re.VERBOSE),

# EMAIL â€” Python í˜¸í™˜(ê°€ë³€í­ lookbehind ì œê±°), ê²½ê³„ ì†Œë¹„ ë°©ì‹
"EMAIL": re.compile(r"""
(?:^|[\s<\(\["':.,;!?=]|[ê°€-í£])     # ì• ê²½ê³„(ì†Œë¹„)
(?:
  # 1) "í‘œì‹œëª…" + <ì´ë©”ì¼>
  (?:"[^"\r\n]*"\s*)?<
    ([A-Za-z0-9._%+-]{1,64}@
      (?:[A-Za-z0-9](?:[A-Za-z0-9-]{0,61}[A-Za-z0-9])?\.)+
      [A-Za-z]{2,63}
    )
  >
  |
  # 2) ì¼ë°˜ ì´ë©”ì¼ (ì—°ì† ì  ê·œì¹™ë§Œ ì²´í¬)
  (?!\.)
  (?!.*\.\.)
  ([A-Za-z0-9._%+-]{1,64}@
    (?:[A-Za-z0-9](?:[A-Za-z0-9-]{0,61}[A-Za-z0-9])?\.)+
    [A-Za-z]{2,63}
  )
)
(?=$|[\s>\)\]"':.,;!?=]|[ê°€-í£])      # ë’¤ ê²½ê³„(lookahead)
""", re.X | re.I),

# PERSONAL_CUSTOMS_ID (ê°œì¸í†µê´€ê³ ìœ ë¶€í˜¸)
"PERSONAL_CUSTOMS_ID": re.compile(
    r"(?i)(?<![0-9A-Za-z])P-?\d{12}(?![0-9A-Za-z])"
),

# RESIDENT_ID (ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸)
"RESIDENT_ID": re.compile(r"""
(?x)
(?<!\d)
(?: (?:0[1-9]|[1-9]\d)
    (?:
      (?:0[13578]|1[02])(?:0[1-9]|[12]\d|3[01]) |
      (?:0[469]|11)(?:0[1-9]|[12]\d|30)        |
      02(?:0[1-9]|1\d|2\d)
    )
)
-[1-4]\d{6}
(?!\d)
""", X),

# PASSPORT
"PASSPORT": re.compile(
    r"(?<![0-9A-Za-z])(?:[A-Z]\d{8}|[A-Z]{2}\d{7})(?![0-9A-Za-z])"
),

# DRIVER_LICENSE
"DRIVER_LICENSE": re.compile(r"(?<!\d)\d{2}-\d{2}-\d{6}-\d{2}(?!\d)"),

# FOREIGNER_ID (ì™¸êµ­ì¸ë“±ë¡ë²ˆí˜¸)
"FOREIGNER_ID": re.compile(r"""
(?x)
(?<!\d)
(?: (?:0[1-9]|[1-9]\d)
    (?:
      (?:0[13578]|1[02])(?:0[1-9]|[12]\d|3[01]) |
      (?:0[469]|11)(?:0[1-9]|[12]\d|30)        |
      02(?:0[1-9]|1\d|2\d)
    )
)
-[5-8]\d{6}
(?!\d)
""", X),

# BUSINESS_ID (ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸)
"BUSINESS_ID": re.compile(r"(?<!\d)\d{3}-\d{2}-\d{5}(?!\d)"),

# MILITARY_ID (êµ°ë²ˆ)
"MILITARY_ID": re.compile(r"(?<![A-Za-z0-9])\d{2}-(?:\d{5}|\d{8})(?![A-Za-z0-9])"),
    
# API_KEY (êµ¬ê¸€/ì˜¤í”ˆAI/ì¹´ì¹´ì˜¤)
"API_KEY": re.compile(r"""
(?x)
(?<![A-Za-z0-9])
(?:
  AIza[0-9A-Za-z_-]{35}
  |
  (?:sk-[A-Za-z0-9]{32,64} | sk-(?:live|test)-[A-Za-z0-9]{24,64} | sk-proj-[A-Za-z0-9]{24,64})
  |
  (?i:KakaoAK)\s+(?P<kakao>[0-9a-f]{32})
)
(?![A-Za-z0-9])
""", X),

# GITHUB_PAT
"GITHUB_PAT": re.compile(r"""
(?xi)
(?<![0-9A-Za-z])
(?:
  (?:ghp|gho|ghu|ghs|ghr)_[A-Za-z0-9_]{36}
  |
  github_pat_[A-Za-z0-9_]{22,255}
)
(?![0-9A-Za-z])
""", X | I),

# PRIVATE_KEY (PEM / OpenSSH / PGP ê°œì¸í‚¤ ë¸”ë¡ ê°ì§€)
"PRIVATE_KEY": re.compile(
    r"-----BEGIN OPENSSH PRIVATE KEY-----\s*[A-Za-z0-9+/=\r\n]+-----END OPENSSH PRIVATE KEY-----"
    r"|-----BEGIN (?:RSA|EC|DSA) PRIVATE KEY-----\s*[A-Za-z0-9+/=\r\n]+-----END (?:RSA|EC|DSA) PRIVATE KEY-----"
    r"|-----BEGIN (?:ENCRYPTED )?PRIVATE KEY-----\s*[A-Za-z0-9+/=\r\n]+-----END (?:ENCRYPTED )?PRIVATE KEY-----"
    r"|-----BEGIN PGP PRIVATE KEY BLOCK-----\s*[\s\S]+?-----END PGP PRIVATE KEY BLOCK-----",
    M | S,
),

# CARD_NUMBER (ë£¨í•œì€ í›„ì²˜ë¦¬)
"CARD_NUMBER": re.compile(r"""
    (?x)
    (?<!\d)
    (?!\d{6}-[1-8]\d{6}(?!\d))   # 6ìë¦¬-í•˜ì´í”ˆ-7ìë¦¬ â†’ ì£¼ë¯¼/ì™¸êµ­ì¸ë²ˆí˜¸ë¡œ ì œì™¸
    (?=[\d -]*-)                 # â˜… ìˆ«ì/ê³µë°±/í•˜ì´í”ˆ ì•ˆì— ì ì–´ë„ í•œ ë²ˆ '-'ê°€ í¬í•¨ë˜ì–´ì•¼ í•¨
    (?:\d[ -]?){13,19}           # ìˆ«ì 13~19ê°œ, ì‚¬ì´ì— ê³µë°± ë˜ëŠ” '-' í—ˆìš©
    (?!\d)
    """, re.VERBOSE),

# IMEI (ë£¨í•œì€ í›„ì²˜ë¦¬)
"IMEI": re.compile(r"(?x)(?<!\d)(?:\d[ -]?){15}(?!\d)"),

# CARD_EXPIRY (ì„ íƒ)
"CARD_EXPIRY": re.compile(r"""
(?x)
(?<!\d)                     # ë°”ë¡œ ì•ì— ìˆ«ì ì˜¤ë©´ ì•ˆ ë¨
(0[1-9]|1[0-2])             # 01~12 (ì›”)
\s*\/\s*                    # / êµ¬ë¶„ìë§Œ í—ˆìš©
(?:
  (?:2[3-9]|3[0-9])         # YY: 23~39 ê°™ì€ í˜•ì‹ (ì˜ˆ: 24, 25, ... 39)
  |
  20(?:2[3-9]|[3-9]\d)      # YYYY: 2023~2099 (ì˜ˆ: 2024, 2030, 2099)
)
(?!\d)                      # ë°”ë¡œ ë’¤ì— ìˆ«ì ì˜¤ë©´ ì•ˆ ë¨
(?!\s*\d{1,2}:\d{2})        # ë’¤ì— ' 10:30' ê°™ì€ ì‹œê°„ íŒ¨í„´ì´ ì˜¤ë©´ ì œì™¸
""", re.VERBOSE),

# BANK_ACCOUNT (êµ­ë‚´ ì£¼ìš” ì‹œì¤‘/ì¸í„°ë„·ì€í–‰/ì§€ë°©ì€í–‰/ìƒí˜¸ê¸ˆìœµ ê³„ì¢Œë²ˆí˜¸ â€“ í•˜ì´í”ˆ/ê³µë°± êµ¬ë¶„í˜•)
# - ì•ë’¤ ìˆ«ì ê²½ê³„: (?<!\d) ... (?!\d)
# - ê° íŒ¨í„´ì€ "ì§€ì ì½”ë“œ-ì¤‘ê°„ì‹ë³„-ê³ ê°ë²ˆí˜¸" ë“± ì‹¤ì œ ê³„ì¢Œë²ˆí˜¸ í•˜ì´í”ˆ ìœ„ì¹˜ë¥¼ ë°˜ì˜
"BANK_ACCOUNT": re.compile(r"""
(?x)
(?<!\d)
(?!\d{4}[- ]\d{4}[- ]\d{4}[- ]\d{4}(?!\d))   # ğŸ”´ 4-4-4-4 ì¹´ë“œë²ˆí˜¸ëŠ” ê³„ì¢Œë¡œ ë³´ì§€ ì•ŠìŒ
(?:
  # -------------------------------------
  # KBêµ­ë¯¼ì€í–‰ / ìš°ì²´êµ­ (ì¼ë¶€ í¬ë§· ê³µìœ )
  # -------------------------------------
  # êµ­ë¯¼ 10ìë¦¬: 000-00-00000 (3-2-5)
  \d{3}[- ]\d{2}[- ]\d{5} |

  # êµ­ë¯¼ 12ìë¦¬: 000-00-0000-000 (3-2-4-3)
  \d{3}[- ]\d{2}[- ]\d{4}[- ]\d{3} |

  # êµ­ë¯¼(êµ¬) / ìš°ì²´êµ­ 14ìë¦¬: 000000-00-000000 (6-2-6)
  \d{6}[- ]\d{2}[- ]\d{6} |

  # -------------------------------------
  # ìš°ë¦¬ì€í–‰
  # -------------------------------------
  \d{4}[- ]\d{3}[- ]\d{6} |

  # -------------------------------------
  # í•˜ë‚˜ì€í–‰ (KEB í•˜ë‚˜)
  # -------------------------------------
  \d{3}[- ]\d{6}[- ]\d{5} |
  \d{3}[- ]\d{3}[- ]\d{6} |

  # -------------------------------------
  # ì‹ í•œ / ìˆ˜í˜‘ / ì¹´ì¹´ì˜¤ë±…í¬ 11ìë¦¬ ê³„ì—´
  # -------------------------------------
  \d{3}[- ]\d{2}[- ]\d{6} |
  \d{3}[- ]\d{3}[- ]\d{6} |

  # -------------------------------------
  # IBK ê¸°ì—…ì€í–‰
  # -------------------------------------
  \d{3}[- ]\d{6}[- ]\d{2}[- ]\d{3} |
  \d{3}[- ]\d{3}[- ]\d{7} |

  # -------------------------------------
  # NH ë†í˜‘ / BNK ë¶€ì‚° / BNK ê²½ë‚¨ / ìˆ˜í˜‘ ì¼ë¶€
  # -------------------------------------
  \d{3}[- ]\d{4}[- ]\d{4}[- ]\d{2} |
  \d{3}[- ]\d{4}[- ]\d{5} |

  # -------------------------------------
  # ìƒˆë§ˆì„ê¸ˆê³  / ì‚°ë¦¼ì¡°í•© / ì¼ë¶€ ìƒí˜¸ê¸ˆìœµ
  # -------------------------------------
  \d{4}[- ]\d{4}[- ]\d{4}[- ]\d{1} |
  \d{3}[- ]\d{2}[- ]\d{6}[- ]\d{1} |

  # -------------------------------------
  # ì¸í„°ë„·ì€í–‰ (ì¹´ì¹´ì˜¤ë±…í¬ / ì¼€ì´ë±…í¬ / í† ìŠ¤ë±…í¬)
  # -------------------------------------
  \d{4}[- ]\d{2}[- ]\d{7} |

  # -------------------------------------
  # ì „ë¶ / ì”¨í‹° / ì œì£¼ / ëŒ€êµ¬ / KDBì‚°ì—… ë“±
  # -------------------------------------
  \d{3}[- ]\d{6}[- ]\d{3} |
  \d{2}[- ]\d{2}[- ]\d{6} |
  \d{3}[- ]\d{2}[- ]\d{6}[- ]\d{1} |
  \d{3}[- ]\d{4}[- ]\d{4}[- ]\d{3}
)
(?!\d)
""", X),

# HD_WALLET (xpub/xprvâ€¦)
"HD_WALLET": re.compile(
    r"(?<![0-9A-Za-z])"                       # ì•ì— ASCII ì˜ë¬¸/ìˆ«ìê°€ ì˜¤ë©´ ì•ˆ ë¨
    r"(?:xpub|ypub|zpub|tpub|xprv|yprv|zprv|tprv)"
    r"[1-9A-HJ-NP-Za-km-z]{100,112}"          # ë³¸ë¬¸(Base58, ê¸¸ì´ ì œí•œ)
    r"(?![0-9A-Za-z])"                        # ë’¤ì— ASCII ì˜ë¬¸/ìˆ«ìê°€ ì˜¤ë©´ ì•ˆ ë¨
),

"PAYMENT_URI_QR": re.compile(r"""
(?x)
(?<![0-9A-Za-z])
(?:
  # -----------------------------
  # 1) Bitcoin URI (BIP-21)
  # -----------------------------
  bitcoin:
    (?:
      [13mn][1-9A-HJ-NP-Za-km-z]{25,34}   # legacy / P2SH / testnet
      |
      bc1[ac-hj-np-z02-9]{11,71}         # bech32 (bc1...)
    )
    (?:\?[A-Za-z0-9%&=_+.\-]+)?
  |
  # -----------------------------
  # 2) Ethereum URI
  # -----------------------------
  ethereum:
    0x[a-fA-F0-9]{40}
    (?:\?[A-Za-z0-9%&=_+.\-]+)?
  |
  # -----------------------------
  # 3) XRP URI
  # -----------------------------
  xrp:
    r[1-9A-HJ-NP-Za-km-z]{24,34}
    (?:\?[A-Za-z0-9%&=_+.\-]+)?
  |
  # -----------------------------
  # 4) Solana URI
  # -----------------------------
  solana:
    [1-9A-HJ-NP-Za-km-z]{32,44}
    (?:\?[A-Za-z0-9%&=_+.\-]+)?
  |
  # -----------------------------
  # 5) Tron URI
  # -----------------------------
  tron:
    T[1-9A-HJ-NP-Za-km-z]{33}
    (?:\?[A-Za-z0-9%&=_+.\-]+)?
  |
  # -----------------------------
  # 6) Bitcoin ìƒ ì£¼ì†Œ (URI ì—†ì´)
  # -----------------------------
  (?:[13mn][1-9A-HJ-NP-Za-km-z]{25,34}
   |
   bc1[ac-hj-np-z02-9]{11,71})
  |
  # -----------------------------
  # 7) Ethereum ìƒ ì£¼ì†Œ (0x...)
  # -----------------------------
  0x[a-fA-F0-9]{40}
)
(?![0-9A-Za-z])
""", X | I),

# IPV4 (CIDR/í¬íŠ¸)
"IPV4": re.compile(r"""
(?x)
(?<!\d)
(?:
  (?:25[0-5]|2[0-4]\d|1?\d?\d)\.
  (?:25[0-5]|2[0-4]\d|1?\d?\d)\.
  (?:25[0-5]|2[0-4]\d|1?\d?\d)\.
  (?:25[0-5]|2[0-4]\d|1?\d?\d)
)
(?:/(?:3[0-2]|[12]?\d))?
(?::(?:6553[0-5]|655[0-2]\d|65[0-4]\d{2}|6[0-4]\d{3}|[1-5]?\d{1,4}))?
(?!\d)
""", X),

# IPV6 (ëŒ€ê´„í˜¸/ë¹„ëŒ€ê´„í˜¸, zone-id, CIDR, í¬íŠ¸)
"IPV6": re.compile(r"""
(?<![0-9A-Fa-f:])                 # ì•ì— ë‹¤ë¥¸ IPv6 ì¡°ê°ì´ ë¶™ì–´ ìˆì§€ ì•Šë„ë¡

(
 (?:
  (?:[0-9A-Fa-f]{1,4}:){7}[0-9A-Fa-f]{1,4} |        # 1:2:3:4:5:6:7:8

  (?:[0-9A-Fa-f]{1,4}:){1,7}: |                     # 1:: ë˜ëŠ” 1:2:3:4:5:6:7::

  (?:[0-9A-Fa-f]{1,4}:){1,6}:[0-9A-Fa-f]{1,4} |     # 1::8   /   1:2:3:4:5:6::8

  (?:[0-9A-Fa-f]{1,4}:){1,5}(?::[0-9A-Fa-f]{1,4}){1,2} | # 1::7:8 ë“±

  (?:[0-9A-Fa-f]{1,4}:){1,4}(?::[0-9A-Fa-f]{1,4}){1,3} |

  (?:[0-9A-Fa-f]{1,4}:){1,3}(?::[0-9A-Fa-f]{1,4}){1,4} |

  (?:[0-9A-Fa-f]{1,4}:){1,2}(?::[0-9A-Fa-f]{1,4}){1,5} |

  [0-9A-Fa-f]{1,4}:(?:(?::[0-9A-Fa-f]{1,4}){1,6}) |

  :(?:(?::[0-9A-Fa-f]{1,4}){1,7}|:)                 # ::, ::1, ::1:2:3:4:5:6:7
 )
 (?:/(?:12[0-8]|1[01][0-9]|[1-9]?[0-9]))?           # /0 ~ /128  (ì˜µì…˜)
)
(?![0-9A-Fa-f:])                 # ë’¤ì— ë‹¤ë¥¸ IPv6 ì¡°ê°ì´ ë¶™ì–´ ìˆì§€ ì•Šë„ë¡
""", re.X | re.I),

# MAC_ADDRESS â€” (ìˆ˜ì •) ëŒ€ë¬¸ì í¬í•¨ ê²€ì¦ lookahead ì œê±°
"MAC_ADDRESS": re.compile(r"(?xi)(?=[0-9A-F]{2}([-:]))[0-9A-F]{2}(?:\1[0-9A-F]{2}){5}"),
}
